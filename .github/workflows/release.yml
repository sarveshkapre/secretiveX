name: Release

on: 
  push:
    tags:
      - '*'
jobs:
  test:
    permissions:
        contents: read
    runs-on: self-hosted
    timeout-minutes: 10
    steps:
    - name: Skip on non-macOS self-hosted runner
      if: runner.os != 'macOS'
      run: |
        echo "Skipping macOS release test job on non-macOS runner"
    - if: runner.os == 'macOS'
      uses: actions/checkout@v5
    - if: runner.os == 'macOS'
      name: Setup Signing
      id: signing
      env: 
        SIGNING_DATA: ${{ secrets.SIGNING_DATA }}
        SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
        HOST_PROFILE_DATA: ${{ secrets.HOST_PROFILE_DATA }}
        AGENT_PROFILE_DATA: ${{ secrets.AGENT_PROFILE_DATA }}
        APPLE_API_KEY_DATA: ${{ secrets.APPLE_API_KEY_DATA }}
        APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
      run: ./.github/scripts/signing.sh
    - if: runner.os == 'macOS'
      name: Require Signing Secrets
      env:
        SIGNING_ENABLED: ${{ steps.signing.outputs.signing_enabled }}
      run: |
            set -euo pipefail
            if [[ "$SIGNING_ENABLED" != "true" ]]; then
              echo "Release builds require signing secrets/profiles to be configured."
              exit 1
            fi
    - if: runner.os == 'macOS'
      name: Set Environment
      run: xcode-select -s "${XCODE_PATH:-/Applications/Xcode_26.2.app}"
    - if: runner.os == 'macOS'
      name: Test
      run: xcrun xcodebuild -project Sources/Secretive.xcodeproj -scheme PackageTests test
      # SPM doesn't seem to pick up on the tests currently?
      # run: swift test --build-system swiftbuild --package-path Sources/Packages
  build:
    permissions:
      id-token: write
      contents: write
      attestations: write
      actions: read
    runs-on: self-hosted
    timeout-minutes: 10
    steps:
    - name: Skip on non-macOS self-hosted runner
      if: runner.os != 'macOS'
      run: |
        echo "Skipping macOS release build job on non-macOS runner"
    - if: runner.os == 'macOS'
      uses: actions/checkout@v5
    - if: runner.os == 'macOS'
      name: Setup Signing
      id: signing
      env: 
        SIGNING_DATA: ${{ secrets.SIGNING_DATA }}
        SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
        HOST_PROFILE_DATA: ${{ secrets.HOST_PROFILE_DATA }}
        AGENT_PROFILE_DATA: ${{ secrets.AGENT_PROFILE_DATA }}
        APPLE_API_KEY_DATA: ${{ secrets.APPLE_API_KEY_DATA }}
        APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
      run: ./.github/scripts/signing.sh
    - if: runner.os == 'macOS'
      name: Require Signing Secrets
      env:
        SIGNING_ENABLED: ${{ steps.signing.outputs.signing_enabled }}
      run: |
            set -euo pipefail
            if [[ "$SIGNING_ENABLED" != "true" ]]; then
              echo "Release builds require signing secrets/profiles to be configured."
              exit 1
            fi
    - if: runner.os == 'macOS'
      name: Set Environment
      run: xcode-select -s "${XCODE_PATH:-/Applications/Xcode_26.2.app}"
    - if: runner.os == 'macOS'
      name: Update Build Number
      env:
        TAG_NAME: ${{ github.ref }}
        RUN_ID: ${{ github.run_id }}
      run: |
            export CLEAN_TAG=$(echo $TAG_NAME | sed -e 's/refs\/tags\/v//')
            sed -i '' -e "s/GITHUB_CI_VERSION/$CLEAN_TAG/g" Sources/Config/Config.xcconfig
            sed -i '' -e "s/GITHUB_BUILD_NUMBER/1.$RUN_ID/g" Sources/Config/Config.xcconfig
            sed -i '' -e "s/GITHUB_BUILD_URL/https:\/\/github.com\/sarveshkapre\/secretiveX\/actions\/runs\/$RUN_ID/g" Sources/Config/Config.xcconfig
    - if: runner.os == 'macOS'
      name: Build
      run: xcrun xcodebuild -project Sources/Secretive.xcodeproj -scheme Secretive -configuration Release -archivePath Archive.xcarchive archive
    - if: runner.os == 'macOS'
      name: Move to Artifact Folder
      run: mkdir Artifact; cp -r Archive.xcarchive/Products/Applications/Secretive.app Artifact
    - if: runner.os == 'macOS'
      name: Create Zip
      run: ditto -c -k --sequesterRsrc --keepParent Artifact/Secretive.app Secretive.zip
    - if: runner.os == 'macOS'
      name: Upload App to Artifacts
      id: upload
      uses: actions/upload-artifact@v4
      with:
        name: Secretive.zip
        path: Secretive.zip
    - if: runner.os == 'macOS'
      name: Notarize
      env: 
        APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
        APPLE_API_ISSUER: ${{ secrets.APPLE_API_ISSUER }}
      run: xcrun notarytool submit --key ~/.private_keys/AuthKey_$APPLE_API_KEY_ID.p8 --key-id $APPLE_API_KEY_ID --issuer $APPLE_API_ISSUER Secretive.zip
    - if: runner.os == 'macOS'
      name: Attest
      id: attest
      uses: actions/attest-build-provenance@v2
      with:
        subject-path: "Secretive.zip"
    - if: runner.os == 'macOS'
      name: Create Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TAG_NAME: ${{ github.ref }}
        RUN_ID: ${{ github.run_id }}
        ATTESTATION_ID: ${{ steps.attest.outputs.attestation-id }}
      run: |
            sed -i.tmp "s/RUN_ID/$RUN_ID/g" .github/templates/release.md
            sed -i.tmp "s/ATTESTATION_ID/$ATTESTATION_ID/g" .github/templates/release.md
            gh release create $TAG_NAME -d -F .github/templates/release.md
            gh release upload $TAG_NAME Secretive.zip
