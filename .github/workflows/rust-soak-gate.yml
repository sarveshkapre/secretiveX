name: Rust Soak Gate

on:
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * 6"

jobs:
  soak-gate:
    runs-on: self-hosted
    timeout-minutes: 45
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Run soak gate
        env:
          SOAK_PROFILE: "pssh"
          SOAK_DURATION_SECS: "1200"
          SOAK_CONCURRENCY: "512"
          SOAK_PAYLOAD_SIZE: "64"
          SOAK_RECONNECT: "1"
          SOAK_WORKER_START_SPREAD_MS: "3000"
          SOAK_MIN_RPS: "15"
          SOAK_MAX_P95_US: "320000"
          SOAK_MAX_FAILURE_RATE: "0.02"
          SOAK_MAX_QUEUE_WAIT_AVG_NS: "40000000"
          SOAK_MAX_QUEUE_WAIT_MAX_NS: "400000000"
          SOAK_REQUIRE_QUEUE_WAIT_METRICS: "1"
          SOAK_OUTPUT_JSON: "${{ runner.temp }}/soak.json"
          SOAK_OUTPUT_METRICS: "${{ runner.temp }}/soak-metrics.json"
        run: ./scripts/ci_retry.sh 2 ./scripts/soak_test.sh

      - name: Upload soak result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rust-soak-result
          path: |
            ${{ runner.temp }}/soak.json
            ${{ runner.temp }}/soak-metrics.json
          if-no-files-found: warn
