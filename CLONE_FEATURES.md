# Clone Feature Tracker

## Context Sources
- README and docs
- TODO/FIXME markers in code
- Test and build failures
- Gaps found during codebase exploration

## Candidate Features To Do
- [ ] Harden reconnect fan-out benches with an optional connect-timeout knob so stalls surface as explicit failures instead of long hangs.
- [x] Improve SLO gate diagnostics to flag `attempted=0` as a likely setup/warmup/config issue before reporting throughput failures.
- [ ] Add confirm/deny telemetry (counters + audit outcomes) to metrics snapshots so dashboards can see prompt rates and denial reasons.
- [ ] Add local/CI smoke coverage for duration-mode reconnect benches with 0 warmup to prevent future fanout gate regressions.
- [ ] Add a strict JSON schema validation step for `secretive-bench` outputs used by gate scripts.
- [ ] Add stale-metrics freshness enforcement to `bench_slo_gate.sh` (matching `secretive-client --metrics-file` freshness checks).
- [ ] Add a bounded failure-budget trend report in gate scripts (compare current failure rate vs previous artifact when available).
- [ ] Add PKCS#11 real-token integration runbook + host prerequisites and wire an opt-in CI workflow for self-hosted hardware.
- [ ] Add Windows named-pipe ACL validation checklist and executable verification script for real-host runs.
- [ ] Cut a tagged Rust CLI release and extend the Homebrew formula with a stable `url` + `sha256` (keep `head` for dev installs).
- [ ] Add a compact `CHANGELOG.md` scaffold and release-note automation check to align with `docs/RELEASE_POLICY.md`.
- [ ] Add a metrics compatibility policy test to prevent accidental schema regressions across `meta.schema_version` changes.

## Implemented
- 2026-02-11: Refactored `bench_slo_gate.sh` failure handling into shared helpers and added an explicit early `attempted=0` SLO failure diagnostic with warmup/duration/config guidance before throughput checks (`scripts/bench_slo_gate.sh`) (27b008a, `./scripts/check_shell.sh`, `AGENT_STARTUP_TIMEOUT_SECS=90 SLO_CONCURRENCY=16 SLO_DURATION_SECS=1 SLO_MIN_RPS=1 SLO_MAX_P95_US=10000000 SLO_MAX_FAILURE_RATE=1 ./scripts/bench_slo_gate.sh`, `AGENT_STARTUP_TIMEOUT_SECS=90 SLO_CONCURRENCY=8 SLO_DURATION_SECS=0 SLO_MIN_RPS=0 SLO_MAX_P95_US=0 SLO_MAX_FAILURE_RATE=1 ./scripts/bench_slo_gate.sh` expected fail with `attempted=0` diagnostic).
- 2026-02-11: Fixed duration-mode benchmark warmup semantics by defaulting `secretive-bench --duration` runs to `warmup=0` unless `--warmup` is explicitly set, added parser regression tests for both default and override behavior, and documented the behavior in bench docs (`crates/secretive-bench/src/main.rs`, `scripts/bench_slo_gate.sh`, `docs/RUST_BENCH.md`) (7d73122, `cargo test -p secretive-bench`, `AGENT_STARTUP_TIMEOUT_SECS=90 SLO_CONCURRENCY=64 SLO_DURATION_SECS=2 SLO_MIN_RPS=1 SLO_MAX_P95_US=10000000 SLO_MAX_FAILURE_RATE=1 ./scripts/bench_slo_gate.sh`).
- 2026-02-11: Reduced CI warning noise by compiling Secure Enclave helper functions only on macOS targets and aligned helper tests with the same target gating to keep Linux clippy green (`crates/secretive-core/src/secure_enclave_store.rs`) (3301e2d, e08a78d, `cargo test -p secretive-core`, `cargo clippy --workspace --all-targets`).
- 2026-02-10: Added OS-specific “approval prompt” helper examples for `policy.confirm_command` (macOS `osascript`, Linux `zenity`/`kdialog`, Windows PowerShell) and documented security/perf tradeoffs (`scripts/confirm_prompt_osascript.sh`, `scripts/confirm_prompt_linux.sh`, `scripts/confirm_prompt_windows.ps1`, `docs/RUST_CONFIG.md`).
- 2026-02-10: Removed unsafe `BytesMut::set_len` usage in the agent request-reading path (read exact frames via `resize(len, 0)` + `read_exact`) and added a regression test to ensure one read does not consume the next frame (`crates/secretive-agent/src/main.rs`) (34e83c5, 32e1511, 67ed34c, `BENCH_CONCURRENCY=64 BENCH_REQUESTS=4 MIN_RPS=1 ./scripts/bench_smoke_gate.sh`).
- 2026-02-10: Added `policy.confirm_command` (timeout + optional per-key cache) so the Rust agent can support `ssh-add -c`-like confirmations via an external command hook, and updated roadmap/architecture/config docs (`crates/secretive-agent/src/main.rs`, `Cargo.toml`, `docs/RUST_CONFIG.md`, `docs/PRODUCT_FEATURES.md`, `docs/ARCHITECTURE.md`) (7820b4c, `cargo test -p secretive-agent`, local confirm deny/allow smoke via `secretive-client --sign`).
- 2026-02-10: Added a local smoke script for the confirm hook (`./scripts/confirm_command_smoke.sh`) so contributors can verify deny/allow behavior quickly (`scripts/confirm_command_smoke.sh`) (70d1da9, `./scripts/confirm_command_smoke.sh`).
- 2026-02-10: Added a Homebrew (head-only) formula for Rust CLIs and documented a `brew install` path (`packaging/homebrew/secretivex.rb`, `README.md`) (0fa78bb, `ruby -c packaging/homebrew/secretivex.rb`).
- 2026-02-10: Documented `secretive-bench` JSON schema notes/versioning expectations for dashboards (schema v3) (`docs/RUST_BENCH.md`) (c173a17).
- 2026-02-10: Gate scripts now consume bench-emitted `queue_wait` JSON (avg/max + tail mode) instead of parsing agent metrics snapshots with embedded python; this removes a runtime Python dependency and keeps verdict inputs in one place (`scripts/bench_slo_gate.sh`, `scripts/soak_test.sh`) (ac0a4a2, `./scripts/check_shell.sh`, `SLO_CONCURRENCY=32 SLO_DURATION_SECS=1 ... ./scripts/bench_slo_gate.sh`, `SOAK_DURATION_SECS=1 ... ./scripts/soak_test.sh`).
- 2026-02-10: Removed `Vec::set_len` uninitialized-buffer patterns in protocol/client parsing so `cargo clippy` passes and we don’t risk exposing uninitialized bytes (`crates/secretive-proto/src/codec.rs`, `crates/secretive-client/src/main.rs`) (ac28203, `cargo test -p secretive-proto`, `cargo test -p secretive-client`, `cargo clippy --workspace --all-targets`).
- 2026-02-10: Added `Rust Lint` workflow running `cargo fmt --check` and `cargo clippy` on push/PR (`.github/workflows/rust-lint.yml`) (c05077c, `ruby -e "require 'yaml'; YAML.load_file(...)"`).
- 2026-02-10: Agent metrics snapshots now include `queue_wait_suggested` (recommended tail_ns/tail_ratio + profile label) so dashboards can compare observed vs recommended envelopes (`crates/secretive-agent/src/main.rs`, `docs/SLO.md`) (857a39f, `cargo test -p secretive-agent`).
- 2026-02-09: `secretive-bench` now counts request-level failures (agent `Failure`, timeouts, connect/write/EOF issues) and exposes a failure breakdown (`request_failures`, `request_timeouts`, `connect_failures`, `worker_failures`) in JSON/CSV (`meta.schema_version=3`) so `ok=0` no longer hides agent-side failures (46790ae, `cargo test -p secretive-bench`).
- 2026-02-09: Added machine-readable / script-friendly outputs for queue-wait guardrail suggestions (`secretive-agent --suggest-queue-wait-json` and `--suggest-queue-wait-quiet`) and documented them (3b62a9f, `cargo test -p secretive-agent`).
- 2026-02-09: Gate scripts now prebuild and run Rust binaries directly (agent/client/bench) and readiness probing prefers `SECRETIVE_CLIENT_BIN`, reducing compile noise and flake risk in CI logs (657254c, 9ad7387, `./scripts/check_shell.sh`, `./scripts/bench_smoke_gate.sh`, `./scripts/bench_slo_gate.sh`).
- 2026-02-09: Fixed failing SecretiveX Nightly/One-Off build workflows by making signing setup conditional (skip when secrets aren’t configured), producing `Secretive.zip` locally (no “upload then curl-download zip”), and updating CI build URLs to point at `sarveshkapre/secretiveX` (b65be6a, 33332a9, `ruby -e "require 'yaml'; YAML.load_file(...)"`, `./scripts/check_shell.sh`).
- 2026-02-09: Fixed updater to query SecretiveX releases (not upstream `sarveshkapre/secretive`) and added a CI smoke check to prevent stale repo URL regressions (`scripts/repo_sanity.sh` wired into Shell Sanity; 84227cc, `./scripts/repo_sanity.sh`).
- 2026-02-09: Resolved `TODO: CHECK VERSION` by detecting stale SecretAgent processes after in-place app updates (compare running process launch time vs on-disk binary mtime; triggers a restart path) (da60605).
- 2026-02-09: Fixed failing scheduled Rust SLO gate by disabling `sign_timeout_ms` in gate-generated agent configs (so the bench measures queue wait instead of timing out under fan-out), hardening gate/soak scripts to fail clearly when latency stats are missing (instead of “failed to parse bench output”), and printing agent log tails on failures for actionable diagnostics (scripts/bench_slo_gate.sh, scripts/bench_smoke_gate.sh, scripts/soak_test.sh, crates/secretive-bench/src/main.rs, `cargo test -p secretive-bench`, `./scripts/check_shell.sh`, `AGENT_STARTUP_TIMEOUT_SECS=90 ./scripts/bench_smoke_gate.sh`, `SLO_CONCURRENCY=64 SLO_DURATION_SECS=3 ... ./scripts/bench_slo_gate.sh`).
- 2026-02-08: Hardened `.github/workflows/windows-agent-smoke.yml` startup path by prebuilding `secretive-agent`/`secretive-client`, running direct binaries (instead of concurrent `cargo run` processes), enforcing a real startup timeout (`AGENT_STARTUP_TIMEOUT_SECS`), checking process liveness, and printing agent log tails on failure. This fixes false-ready behavior caused by PowerShell `try/catch` not handling non-zero external command exits (windows-agent-smoke.yml, `ruby -e "require 'yaml'; YAML.load_file(...)"`).
- 2026-02-08: Tuned regression latency envelope for hosted CI variance by raising the default `REGRESSION_SLO_MAX_P95_US` from `500000` to `900000` after observing consistent ~740-760ms p95 on GitHub-hosted Linux despite healthy throughput/failure metrics (scripts/regression_gate.sh, `AGENT_STARTUP_TIMEOUT_SECS=90 ./scripts/regression_gate.sh`).
- 2026-02-08: Stabilized `scripts/regression_gate.sh` SLO defaults for hosted CI by reducing reconnect SLO fan-out pressure (`REGRESSION_SLO_CONCURRENCY` 256 -> 64, `REGRESSION_SLO_DURATION_SECS` 8 -> 10) so regression gates continue to validate latency/reliability without over-saturating shared runners (scripts/regression_gate.sh, `AGENT_STARTUP_TIMEOUT_SECS=90 ./scripts/regression_gate.sh`).
- 2026-02-08: Fixed CI smoke/gate flake root cause where cold-start `cargo run` compilations could exceed 10-12s readiness loops. Added shared helper `scripts/wait_for_agent_ready.sh` with configurable timeout (`AGENT_STARTUP_TIMEOUT_SECS`, default 90s), agent PID liveness checks, and automatic startup-log tail diagnostics on failure (scripts/wait_for_agent_ready.sh, scripts/openssh_compat_smoke.sh, scripts/bench_smoke_gate.sh, scripts/bench_slo_gate.sh, scripts/pkcs11_smoke.sh, scripts/soak_test.sh).
- 2026-02-08: Documented the new readiness timeout and diagnostics behavior for smoke/gate operators (README.md, docs/OPENSSH_COMPAT.md, docs/RUST_BENCH.md).
- 2026-02-08: Verification evidence:
  - `./scripts/check_shell.sh` (pass)
  - `AGENT_STARTUP_TIMEOUT_SECS=90 ./scripts/openssh_compat_smoke.sh` (pass)
  - `AGENT_STARTUP_TIMEOUT_SECS=90 ./scripts/bench_smoke_gate.sh` (pass)
  - `SLO_CONCURRENCY=128 SLO_DURATION_SECS=5 SLO_MIN_RPS=10 SLO_MAX_P95_US=1000000 SLO_MAX_FAILURE_RATE=0.1 AGENT_STARTUP_TIMEOUT_SECS=90 ./scripts/bench_slo_gate.sh` (pass)
  - `AGENT_STARTUP_TIMEOUT_SECS=90 ./scripts/regression_gate.sh` (pass)
  - `PKCS11_SMOKE_REQUIRE_TOOLS=0 AGENT_STARTUP_TIMEOUT_SECS=90 ./scripts/pkcs11_smoke.sh` (skipped on this host due missing `softhsm2-util`; CI installs tools and runs with `PKCS11_SMOKE_REQUIRE_TOOLS=1`)
- 2026-02-08: Added `secretive-agent --suggest-queue-wait` to inspect the merged config + hardware concurrency and print profile-aware queue-wait guardrail recommendations plus export-ready env vars (crates/secretive-agent/src/main.rs, README.md, docs/RUST_CONFIG.md, docs/SLO.md, cargo test -p secretive-agent).
- 2026-02-08: `secretive-client --metrics-file` can now enforce queue-wait guardrails (profiles, explicit thresholds, and freshness checks) using the new `--queue-wait-tail-*` / `--queue-wait-max-age-ms` flags, failing fast with exit code 3 when snapshots are stale or over the envelope (crates/secretive-client/src/main.rs, docs/RUST_CLIENT.md, docs/SLO.md, README.md, cargo test -p secretive-client).
- 2026-02-08: Added SIGUSR2/`secretive-agent --reset-metrics` admin helper so operators can zero metrics counters mid-run and emit a fresh snapshot (crates/secretive-agent/src/main.rs, README.md, docs/RUST_CONFIG.md, cargo test -p secretive-agent).
- 2026-02-08: Bench SLO gate enforces histogram-derived queue-wait tail ratios so p95/p99 regressions surface automatically (scripts/bench_slo_gate.sh, README.md, docs/SLO.md, docs/RUST_BENCH.md).
- 2026-02-08: Bench SLO gate now auto-picks queue-wait tail thresholds per profile so developers/CI get sensible guardrails out of the box (scripts/bench_slo_gate.sh, README.md, docs/SLO.md, docs/RUST_BENCH.md).
- 2026-02-08: Added queue wait histogram tracking/export in Rust agent metrics and surfaced it via `secretive-client --metrics-file` (crates/secretive-agent/src/main.rs, crates/secretive-client/src/main.rs, README/docs updates, tests).
- 2026-02-08: `secretive-client --metrics-file` now prints queue-wait percentile estimates (p50/p90/p95/p99) directly from histogram buckets so humans can eyeball tail pressure without spreadsheets (crates/secretive-client/src/main.rs, docs/RUST_CLIENT.md, cargo test -p secretive-client).
- 2026-02-08: Agent snapshots now embed `queue_wait_percentiles` (p50/p90/p95/p99) and the CLI prefers them before falling back to histogram math, so SLO reviews get exact tail numbers on every scrape (crates/secretive-agent/src/main.rs, crates/secretive-client/src/main.rs, README.md, docs/RUST_CONFIG.md, docs/RUST_CLIENT.md, docs/SLO.md, cargo test -p secretive-agent, cargo test -p secretive-client).
- 2026-02-08: Bench SLO gate prefers agent-provided queue-wait percentiles for tail enforcement, falling back to histograms only when necessary, so pipeline verdicts no longer depend on ad-hoc parsing (scripts/bench_slo_gate.sh, README.md, docs/SLO.md, docs/RUST_BENCH.md, ./scripts/bench_slo_gate.sh).
- 2026-02-08: `secretive-bench` records queue-wait guardrails/percentiles directly in its JSON (CLI/env flags + docs + tests) so dashboards can ingest the exact thresholds applied during SLO runs (crates/secretive-bench/src/main.rs, docs/RUST_BENCH.md, docs/SLO.md, scripts/bench_slo_gate.sh, scripts/soak_test.sh, cargo test -p secretive-bench).

## Insights
- Duration-based reconnect benches are vulnerable to hidden default warmup costs at high concurrency; explicit `SLO_WARMUP=0` plus duration-aware bench defaults prevent false-zero throughput failures (`attempted=0`) in fanout gates.
- Most recent CI failures across OpenSSH/bench/regression/PKCS11 gates shared the same signature (`agent failed to become ready`) and were caused by short readiness windows rather than functional regressions in agent behavior.
- A shared readiness helper is materially better than copy-pasted loops: one timeout knob, one diagnostics format, and consistent process-liveness handling across all gates.
- Scheduled macOS workflows need a “no secrets” fast-path: attempting code signing/notarization on scheduled runners without configured secrets is noise; skipping cleanly keeps the pipeline green while still providing unsigned artifacts for inspection.
- “Repo URL drift” (upstream `secretive` vs `secretiveX`) is easy to reintroduce and hard to spot; a tiny, cheap `rg`-backed sanity check catches it early in CI.
- Synthetic CI gate configs should not inherit production-style timeouts (for example `sign_timeout_ms`): they can zero out throughput and hide the real queue-wait behavior under fan-out; gates should instead enforce SLOs via the bench’s own latency/queue-wait envelopes and produce clear diagnostics when samples are missing.
- Queue-wait regressions were hard to diagnose with only avg/max; histogram buckets now expose whether tail latency or bursts are driving pressure, and the client can show that without jq.
- Human-friendly percentile summaries make it obvious when p95+ queue wait spikes, so operators can set alert thresholds without exporting the histogram elsewhere.
- Tail-ratio gating turns histogram data into an actionable SLO knob, so we can alert on 5%+ queue waits before averages move—next we should auto-suggest sane thresholds per workload profile.
- Auto guardrails ensure every gate run enforces a tail envelope even if engineers forget to export env vars; we should follow up with tooling that surfaces the chosen thresholds alongside the observed percentiles.
- Resetting counters with SIGUSR2 or the CLI helper keeps dashboards from mixing baselines when incidents happen, so observability tooling can treat each interval independently without recycling the agent.
- Precomputing percentiles in the agent keeps us aligned with modern observability guidance (for example, [Anyscale's latest latency benchmarking guide](https://docs.anyscale.com/llm/serving/benchmarking/metrics) and [Google SRE's "Metrics That Matter"](https://cacm.acm.org/practice/metrics-that-matter/) both insist on monitoring p50/p95/p99), reducing toil for both humans and scripts inspecting queue pressure.
- Tail verdicts now resolve instantly when percentiles exist, so SLO gates stay actionable even if histogram buckets are missing (or redacted) from field captures.
- Embedding the queue-wait guardrail inputs/output straight into bench JSON gives us a clean, machine-readable audit trail for every CI run; now we can diff actual percentiles vs thresholds without parsing shell logs, which sets up future alerting in Grafana/Looker or even a `--suggest-queue-wait` CLI.
- Offline guardrail checks plus capture/start timestamps mean ops teams can fail a run the moment a metrics snapshot looks stale or violates the envelope, without rerunning `secretive-bench` just to confirm tail pressure.
- Guardrail tuning is opinionated enough that `--suggest-queue-wait` can unblock operators instantly, but automation needs a JSON output mode and pipeline integration so benches can adopt the recommendations without manual copy/paste.
- Prebuilding and running `target/debug/*` binaries inside the gates makes agent logs actually be agent logs; it also makes startup failures easier to reason about because Cargo compilation output is no longer interleaved.
- `--suggest-queue-wait-quiet` is the right CI integration surface: stable key/value lines that gates can consume without `eval` or ad-hoc parsing of human prose.

## Notes
- This file is maintained by the autonomous clone loop.
